#!/bin/sh

':' // ; exec "$(command -v nodejs || command -v node)" "$0" "$@"
;

'use strict';

const fs = require('fs');
const watch = require('node-watch');
const spawn = require('child_process').spawn;

const builder = require('../lib/builder');
const parser = require('../lib/parsing');

const children = [];

// FIXME: better CLI (log-pose?)
const src = 'music';

const prefix = '♫ MIDI on Scoops!';
const CLR = '\x1b[K';

function play(name) {
  process.stdout.write(`\b  ( ${prefix} ) Loading ${name} ...${CLR}\r`);

  const text = fs.readFileSync(name).toString();
  const ast = parser(text);
  const code = builder(ast);

  children.forEach((child, i) => {
    children.splice(i, 1);
    child.kill('SIGINT');
  });

  const audio = name.replace('.txt', '.mid');

  code
    .save(audio)
    .then(() => {
      process.stdout.write(`\b  ( ${prefix} ) ► Playing: ${audio}${CLR}\r`);

      const child = spawn('timidity', [audio], {
        detached: true,
      });

      child.on('close', () => {
        process.stdout.write(`\b  ( ${prefix} ) ⏏ Done playing: ${audio}${CLR}\r`);

        setTimeout(() => {
          process.stdout.write(`\b  ( ${prefix} ) Watching from: ${src} ...${CLR}\r`);
        }, 3000);
      });

      children.push(child);
    });
}

let i = 0;

const chars = '\\|/-';

setInterval(() => {
  process.stdout.write(`\b${chars[i % chars.length]}\r`);
  i++;
}, 260);

if (process.argv.slice(2)[0]) {
  play(process.argv.slice(2)[0]);
} else {
  process.stdout.write(`\b  ( ${prefix} ) Watching from: ${src} ...${CLR}\r`);

  watch(src, { recursive: true, filter: /\.txt$/ }, (evt, name) => {
    try {
      play(name);
    } catch (e) {
      process.stdout.write(`${e.message}\n`);
    }

    process.stdout.write(`\b  ( ${prefix} ) ${name} changed${CLR}\r`);
  });
}

process.on('SIGINT', () => {
  process.stdout.write('\r\r');

  children.forEach((child, i) => {
    children.splice(i, 1);
    child.kill('SIGINT');
  });

  process.exit(1);
});
